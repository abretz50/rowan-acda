<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Rowan ACDA</title>
<meta name="description" content="Rowan ACDA — American Choral Directors Association collegiate chapter at Rowan University."/>

<!-- Speed up the sheet fetch -->
<link rel="preconnect" href="https://docs.google.com" crossorigin>
<link rel="dns-prefetch" href="https://docs.google.com">

<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Outfit:wght@500;700;800&display=swap" rel="stylesheet"/>
<link rel="icon" href="/assets/icons/favicon-32.png"/>
<meta name="theme-color" content="#7A0A0A"/>
<link rel="stylesheet" href="/css/base.css"/>
<link rel="stylesheet" href="/css/layout.css"/>
<link rel="stylesheet" href="/css/components.css"/>

<style>
  /* Inline red “Add to Calendar” link */
  .event-meta .calendar-link{
    color:#7A0A0A; font-weight:700;
  }
  .event-meta .calendar-link:hover,
  .event-meta .calendar-link:focus{ text-decoration:underline; }

  /* Tags: red text + red outline (matches Events page) */
  .event-badges .badge{
    color:#7A0A0A; border:1.6px solid #7A0A0A; background:#fff; font-weight:700;
  }

  /* Hide scrollbar in any modal dialog, keep it scrollable */
  .modal .dialog{ overflow:auto; -ms-overflow-style:none; scrollbar-width:none; }
  .modal .dialog::-webkit-scrollbar{ display:none; }

  /* ===== Fading slideshow (bigger) ===== */
  .slideshow-wrap{
    border:1px solid var(--border);
    border-radius:1rem;
    overflow:hidden;
    background:#fff;
  }
  .slideshow{
    position:relative;
    width:100%;
    height:clamp(260px, 45vw, 540px); /* bigger, responsive */
    background:#f7f7f7;
  }
  .slideshow img{
    position:absolute; inset:0;
    width:100%; height:100%;
    object-fit:cover;
    opacity:0;
    transition:opacity 900ms ease;
    /* perf hints */
    backface-visibility:hidden;
    transform:translateZ(0);
    will-change:opacity;
  }
  .slideshow img.active{ opacity:1; }
  /* smoother, longer cross-fade */
.slideshow img{
  position:absolute; inset:0;
  width:100%; height:100%;
  object-fit:cover;
  opacity:0;
  transition: opacity 1.8s cubic-bezier(.22,.61,.36,1); /* was 900ms ease */
  backface-visibility:hidden;
  transform:translateZ(0);
  will-change:opacity;
}
/* Home only: hide tags and buttons inside Featured Events */
#home-events .event-badges,
#home-events .event-actions,
#home-events [data-modal],
#home-events [data-action="signin"]{
  display: none !important;
}

</style>
</head>
<body>

<header class="site-header" role="banner">
  <div class="container header-inner">
    <a class="brand" href="/" aria-label="Rowan ACDA Home">
      <img src="/assets/icons/acda.png" alt="ACDA logo">
      <span>Rowan ACDA</span>
    </a>
    <button id="nav-toggle" aria-controls="site-nav" aria-expanded="false" aria-label="Toggle navigation">☰</button>
    <nav id="site-nav" class="nav" role="navigation">
      <a class="nav-link" data-nav href="/">Home</a>
      <a class="nav-link" data-nav href="/events.html">Events</a>
      <a class="nav-link" data-nav href="/members.html">Members</a>
      <a class="nav-link" data-nav href="/eboard.html">E-Board</a>
      <a class="nav-link" data-nav href="/resources.html">Resources</a>
    </nav>
  </div>
</header>

<main class="container" role="main" style="padding:1.25rem 0 2rem">
  <section class="banner-outer" role="region" aria-label="Home header">
    <div class="page-banner"
         style="--banner-img:url('/assets/img/index-header.jpg')">
      <div class="container">
        <h1 class="page-banner__title">Rowan ACDA</h1>
        <p class="page-banner__subtext">Sing. Lead. Inspire.</p>
      </div>
    </div>
  </section>

    <section style="margin-top:2rem">
    <h2>What is Rowan ACDA?</h2>
    <p>The Rowan American Choral Directors Association's mission is to create opportunities for students to learn more about an array of different choral techniques and aspects that will enrich and supplement their education. This includes fundraising, holding events and activities that either interest or inform members, and bringing in presenters from on and off-campus to hold workshops and masterclasses. Our goal is to allow everyone to learn about and experience choral music while acquiring various choral directing skills.</p>
    <p><a class="btn btn-outline" href="/members.html">Read More</a></p>
  </section>




  <section style="margin-top:2rem" aria-labelledby="feat-h">
    <div class="section-header">
      <h2 id="feat-h">Featured Events</h2>
      <div class="actions"><a class="btn btn-outline" href="/events.html">All events</a></div>
    </div>
    <div id="home-events" class="events-feature" aria-live="polite"></div>
  </section>
  
  <!-- ===== Chapter Highlights (FADING SLIDESHOW) ===== -->
  <section style="margin-top:2rem" aria-labelledby="highlights-h">
    <h2 id="highlights-h">Chapter Highlights</h2>
    <div class="slideshow-wrap">
      <div class="slideshow" aria-label="Chapter Highlights Slideshow">
        <!-- One set of images; JS will fade through them -->
        <img src="/assets/img/52854312589_d89aa02f51_o-scaled.jpg" alt="Highlight photo" loading="eager" class="active">
	<img src="/assets/img/Screenshot 2025-09-24 094012.png" alt="Highlight photo" loading="lazy">
        <img src="/assets/img/Screenshot 2025-09-24 093949.png" alt="Highlight photo" loading="lazy">
        <img src="/assets/img/Screenshot 2025-09-24 094001.png" alt="Highlight photo" loading="lazy">
        <img src="/assets/img/Screenshot 2025-09-24 094018.png" alt="Highlight photo" loading="lazy">
        <img src="/assets/img/Screenshot 2025-09-24 094022.png" alt="Highlight photo" loading="lazy">
	<img src="/assets/img/52854526795_0c57dd3603_o-1170x500.jpg" alt="Highlight photo" loading="lazy">
        <img src="/assets/img/506047153_10235311168936420_6729702158962901355_n.jpg" alt="Highlight photo" loading="lazy">
        <img src="/assets/img/53630626_10156972764351558_1406328161368539136_n.jpg" alt="Highlight photo" loading="lazy">
        <img src="/assets/img/Screenshot 2025-08-28 154922.png" alt="Highlight photo" loading="lazy">
        <img src="/assets/img/Screenshot 2025-08-28 154928.png" alt="Highlight photo" loading="lazy">
        <img src="/assets/img/Screenshot 2025-08-28 154950.png" alt="Highlight photo" loading="lazy">
        <img src="/assets/img/Screenshot 2025-08-28 155003.png" alt="Highlight photo" loading="lazy">
        <img src="/assets/img/Screenshot 2025-08-28 154905.png" alt="Highlight photo" loading="lazy">
        <img src="/assets/img/88321339_1520072311502572_3698786862781956096_n.jpg" alt="Highlight photo" loading="lazy">
        <img src="/assets/img/ext2_Screenshot 2025-08-28 154916.png" alt="Highlight photo" loading="lazy">
        <img src="/assets/img/ext_gallery4.png" alt="Highlight photo" loading="lazy">
        <img src="/assets/img/index-header.jpg" alt="Highlight photo" loading="lazy">
        <img src="/assets/img/members-banner.jpg" alt="Highlight photo" loading="lazy">
      </div>
    </div>
  </section>
  <!-- Focus Areas -->
  <section style="margin-top:2rem" aria-labelledby="focus-h">
    <div class="section-header">
      <h2 id="focus-h">Our Chapter</h2>
    </div>

    <div class="events-feature">
      <!-- Choral Engagement -->
      <article class="card">
        <img src="/assets/img/choral-engagement.jpg" alt="Choral Engagement" loading="lazy"
             onerror="this.onerror=null;this.src='/assets/img/about2.png'">
        <div class="meta">
          <h3>Choral Engagement</h3>
          <p>Did you love choir in High School? Want to sing in a growing choral community of many majors?  Join Rowan's own "Choir Club"! Rowan's chapter of the American Choral Director's Associciation is committed to providing musically engaging choral experiences for students of all skill levels. Join us on Fridays at 3:00pm in Wilson 107! </p>
        </div>
      </article>

      <!-- Sightreading -->
      <article class="card">
        <img src="/assets/img/sightreading.jpg" alt="Sightreading" loading="lazy"
             onerror="this.onerror=null;this.src='/assets/img/about1.png'">
        <div class="meta">
          <h3>Sightreading</h3>
          <p>Our chapter hosts themed weekly sight-reading sessions for students to grow their aural music theory skills. Students will have the opportunity to sing a broad range of repertoire in sessions hosted by our executive board. Everyone is encouraged to bring their own material for the group to read with prior approval! </p>
        </div>
      </article>

      <!-- Development -->
      <article class="card">
        <img src="/assets/img/development.jpg" alt="Development" loading="lazy"
             onerror="this.onerror=null;this.src='/assets/img/about.png'">
        <div class="meta">
          <h3>Development</h3>
          <p>In sessions coordinated by our Vice President, industry professionals will present development sessions on varying revelevant topics in the modern Choral Direction and Education field. The chapter also facilitates student and faculty led workshops on conducting, sight-reading techniques, and other choral skills per the Chapter's interests and needs. </p>
        </div>
      </article>
    </div>
  </section>



  

  <section style="margin-top:2rem" aria-labelledby="contact-h">
    <h2 id="contact-h">Contact & Join</h2>
    <p>Have questions? Email <a href="mailto:rowanacda1@gmail.com">rowanacda1@gmail.com</a>. Ready to get started?</p>
    <p><a class="btn" href="/members.html">Become a Member</a></p>
  </section>
</main>

<!-- About modal -->
<div class="modal" id="about-popup"><div class="dialog" tabindex="-1">
  <h3>About Rowan ACDA</h3>
  <p>Rowan ACDA is one of the most active collegiate ACDA chapters in the region. 
  We participate in conferences, host our own Cabaret, and bring in guest clinicians. 
  Membership provides both community and professional growth.</p>
  <p><button class="btn btn-outline" onclick="this.closest('.modal').classList.remove('open')">Close</button></p>
</div></div>

<!-- Heads-up modal (for missing RSVP links, like on Events page) -->
<div class="modal" id="notice-modal" role="dialog" aria-modal="true" aria-labelledby="notice-title" hidden>
  <div class="dialog" tabindex="-1">
    <div class="modal-header" style="text-align:center">
      <h3 class="modal-title" id="notice-title">Heads up</h3>
      <button class="modal-close" type="button" data-close aria-label="Close">✕</button>
    </div>
    <section style="text-align:center">
      <p>This form is not open yet. Check back closer to the event.</p>
    </section>
  </div>
</div>

<footer class="site-footer acda-footer" role="contentinfo">
  <div class="container footer-grid">
    <!-- Brand / blurb -->
    <div class="footer-brand">
      <div class="brand--footer">
        <img src="/assets/icons/acda.png" alt="Rowan ACDA logo" width="40" height="40">
        <div class="brand-text">
          <strong>Rowan ACDA</strong>
          <div class="muted">Collegiate Chapter</div>
        </div>
      </div>
      <p class="muted" style="margin-top:.75rem">
        American Choral Directors Association at Rowan University. We sing, lead, and serve through choral music.
      </p>
    </div>

    <!-- Navigate -->
    <nav aria-label="Footer" class="footer-nav">
      <h4>Navigate</h4>
      <ul class="list-unstyled">
        <li><a href="/events.html">Events</a></li>
        <li><a href="/members.html">Members</a></li>
        <li><a href="/eboard.html">E-Board</a></li>
        <li><a href="/resources.html">Resources</a></li>
      </ul>
    </nav>

    <!-- Connect -->
    <div class="footer-connect">
      <h4>Connect</h4>
      <ul class="list-unstyled">
        <li><a href="mailto:rowanacda1@gmail.com">rowanacda1@gmail.com</a></li>
        <li><a href="https://www.instagram.com/rowanacda/" target="_blank" rel="noopener">Instagram</a></li>
      </ul>
      <p class="small muted footer-note">
        Site theme by Adam Bretz 
      </p>
      <p class="small muted">© <span id="year"></span> Rowan ACDA</p>
    </div>
  </div>
</footer>


<!-- Fading slideshow JS -->
<script>
(function(){
  const container = document.querySelector('.slideshow');
  if(!container) return;
  const slides = Array.from(container.querySelectorAll('img'));
  if(slides.length === 0) return;

  let i = 0, timer = null, running = false;
const FADE_MS = 900;   // match the CSS 1.8s
const HOLD_MS = 2600;   // how long each slide stays fully visible
const INTERVAL = FADE_MS + HOLD_MS; // total per slide ~7s


  function show(n){
    slides.forEach((img, idx)=> img.classList.toggle('active', idx === n));
  }
  function start(){
    if(running || slides.length < 2) return;
    running = true;
    timer = setInterval(()=>{ i = (i+1) % slides.length; show(i); }, INTERVAL);
  }
  function stop(){
    running = false;
    if(timer){ clearInterval(timer); timer = null; }
  }

  // Init
  show(0);

  // Pause when off-screen or tab hidden
  const io = new IntersectionObserver(([entry])=>{
    entry.isIntersecting ? start() : stop();
  }, { threshold: 0.2 });
  io.observe(container);

  document.addEventListener('visibilitychange', () => {
    document.hidden ? stop() : start();
  });
})();
</script>

<script>
/* Home: show only the next 3 upcoming events (with primary CSV + Google Sheet fallback) */
(function(){
  // === CSV sources + robust fetch with fallback ===
  const PRIMARY_CSV = "/assets/data/events.csv"; // mirrored copy on your site
  const BACKUP_CSV  = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQgnEZCsF6om55MFRpD3Dy3xLNF0nSO7U228ijGXkZGSGPpZMqGitInVmgi6y8cYF56mEK8GOuGl0D7/pub?gid=0&single=true&output=csv";

  async function fetchCSV(){
    const isIOS = /iP(hone|ad|od)/i.test(navigator.userAgent);
    const isMobileSafari = isIOS && /Safari/i.test(navigator.userAgent) && !/CriOS|FxiOS/i.test(navigator.userAgent);

    const ctl = new AbortController();
    const t = setTimeout(()=>ctl.abort(), 10000);

    const baseOpts = {
      mode: 'cors',
      credentials: 'omit',
      signal: ctl.signal,
      ...(isMobileSafari ? {} : { cache: 'no-cache' })
    };

    async function get(url){
      const r = await fetch(url, baseOpts);
      if(!r.ok) throw new Error("HTTP "+r.status);
      return r.text();
    }

    try{
      const txt = await get(PRIMARY_CSV);
      clearTimeout(t);
      return txt;
    } catch {
      try { return await get(BACKUP_CSV); }
      finally { clearTimeout(t); }
    }
  }

  const listEl = document.getElementById('home-events');

  /* ---------- CSV helpers ---------- */
  function parseCSV(text){
    const rows = []; let i=0, field='', row=[], inQuotes=false;
    while(i < text.length){
      const c = text[i];
      if(inQuotes){
        if(c === '"'){ if(text[i+1] === '"'){ field += '"'; i++; } else inQuotes = false; }
        else field += c;
      } else {
        if(c === '"') inQuotes = true;
        else if(c === ','){ row.push(field); field=''; }
        else if(c === '\n'){ row.push(field); field=''; rows.push(row); row=[]; }
        else if(c === '\r'){ /* ignore */ }
        else field += c;
      }
      i++;
    }
    if(field.length || row.length){ row.push(field); rows.push(row); }
    return rows;
  }
  function toRecords(rows){
    if(!rows.length) return [];
    const header = rows.shift().map(h=>h.trim().toLowerCase());
    return rows.map(r=>{ const o={}; header.forEach((h,i)=> o[h]=(r[i]||'').trim()); return o; });
  }

  /* ---------- Date/time helpers (robust) ---------- */
  function parseDate(dStr){
    if(!dStr) return null;
    const s = dStr.trim();
    // allow M/D or M/D/YY or M/D/YYYY
    const m = s.match(/^(\d{1,2})[\/\.-](\d{1,2})(?:[\/\.-](\d{2,4}))?$/);
    if(!m) return null;
    let mm=+m[1], dd=+m[2];
    let yy = m[3] ? +m[3] : (new Date()).getFullYear();
    if(yy<100) yy=2000+yy;
    return new Date(yy, mm-1, dd);
  }
  function parseTime(tStr){
    if(!tStr) return null;
    let s = String(tStr).trim().toLowerCase().replace(/[\u2013\u2014]/g, '-');
    if(/\bnoon\b/.test(s)) return {h:12,m:0};
    if(/\bmidnight\b/.test(s)) return {h:0,m:0};
    const m = s.match(/^\s*(\d{1,2})(?::(\d{2}))?(?::\d{2})?\s*([ap]\.?\s*m\.?)?\s*$/i);
    if(!m) return null;
    let h=parseInt(m[1],10), mm=m[2]?parseInt(m[2],10):0, ap=m[3]?m[3].replace(/\./g,'').trim():'';
    if(ap){ if(ap.startsWith('p') && h<12) h+=12; if(ap.startsWith('a') && h===12) h=0; }
    return {h, m:mm};
  }
  function parseTimeRange(s){
    if(!s) return null;
    let str = String(s).toLowerCase().replace(/[–—]/g,'-').replace(/\s+/g,' ').trim();
    const m = str.match(/^(.+?)\s*-\s*(.+)$/);
    if(!m) return null;
    let a = m[1].trim(), b = m[2].trim();
    const suffix = b.match(/\b([ap])\.?m\.?\b/);
    if(suffix && !/\b([ap])\.?m\.?\b/.test(a)) a += ' ' + suffix[0];
    const t1 = parseTime(a), t2 = parseTime(b);
    if(!t1 || !t2) return null;
    return {start:t1, end:t2};
  }
  function combineDateTime(d, t){ const dt=new Date(d); const time=t||{h:0,m:0}; dt.setHours(time.h,time.m,0,0); return dt; }
  function formatDateRange(start, end){
    const dOpt={month:'long',day:'numeric',year:'numeric'};
    const tOpt={hour:'numeric',minute:'2-digit'};
    const dFmt=new Intl.DateTimeFormat('en-US',dOpt), tFmt=new Intl.DateTimeFormat('en-US',tOpt);
    const same = start.toDateString()===end.toDateString();
    return same ? dFmt.format(start)+' • '+tFmt.format(start)+'–'+tFmt.format(end)
                : dFmt.format(start)+' '+tFmt.format(start)+' → '+dFmt.format(end)+' '+tFmt.format(end);
  }
  function tagSlug(s){ return (s||'').toLowerCase().replace(/\s+/g,'-'); }
  function normalizeTags(s){ return !s?[]: s.split(/[,;/|]+/).map(v=>v.trim()).filter(Boolean); }

  /* ---------- Labels & links ---------- */
  function getBtnLabel(ev){
    const tags = new Set((ev.tagSlugs||[]).map(String));
    if (tags.has('volunteer')) return 'Sign up';
    if (tags.has('performance') || tags.has('performances')) return 'Tickets';
    if (tags.has('professional-development') || tags.has('event') || tags.has('events')) return 'Check in';
    return 'Attendance';
  }
  function gcalLink(ev){
    const text = encodeURIComponent(ev.title || 'ACDA Event');
    const details = encodeURIComponent((ev.details || ev.description || '') + (ev.signin_link ? '\n\nRSVP: ' + ev.signin_link : ''));
    const location = encodeURIComponent(ev.location || '');
    const tz = 'America/New_York';
    const s = ev.startDateTime, e = ev.endDateTime;
    const dates = s.getFullYear()+String(s.getMonth()+1).padStart(2,'0')+String(s.getDate()).padStart(2,'0')+'T'+
                  String(s.getHours()).padStart(2,'0')+String(s.getMinutes()).padStart(2,'0')+'00/'+
                  e.getFullYear()+String(e.getMonth()+1).padStart(2,'0')+String(e.getDate()).padStart(2,'0')+'T'+
                  String(e.getHours()).padStart(2,'0')+String(e.getMinutes()).padStart(2,'0')+'00';
    return 'https://calendar.google.com/calendar/render?action=TEMPLATE&text='+text+'&dates='+dates+'&ctz='+tz+'&details='+details+'&location='+location;
  }
  function badgeHTML(tags){ return (tags||[]).map(t=>'<span class="badge" data-tag="'+tagSlug(t)+'">'+t+'</span>').join(' '); }

  /* ---------- Cards (home “Featured Events” style) ---------- */
  function cardHTML(ev){
    const hasLink = !!ev.signin_link;
    const btnLabel = getBtnLabel(ev);
    const signinHref = hasLink ? ev.signin_link : '#';
    const img = ev.image_url || '/assets/img/about.png';

    return (
      '<article class="card" data-tags="'+ev.tagSlugs.join(' ')+'" data-when="'+ev.when+'">'+
        '<img src="'+img+'" alt="'+(ev.title||'Event photo')+'" loading="lazy" onerror="this.onerror=null;this.src=\'/assets/img/about.png\'">'+
        '<div class="meta">'+
          '<h3>'+ (ev.title||'Untitled') +'</h3>'+
          '<p class="kicker event-meta"><strong>'+ (ev.datePretty||'') +'</strong>'+
            (ev.location? ' • '+ev.location : '')+
            ' • <a class="calendar-link" href="'+ gcalLink(ev) +'" target="_blank" rel="noopener">Add to Calendar</a>'+
          '</p>'+
          '<div class="event-badges" style="margin:.4rem 0 .4rem">'+ badgeHTML(ev.tags) +'</div>'+
          (ev.description ? '<p>'+ev.description+'</p>' : '')+
          '<div class="event-actions" style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.6rem">'+
            '<a class="btn" data-action="signin" data-has-link="'+(hasLink?'1':'0')+'" href="'+signinHref+'" target="_blank" rel="noopener">'+btnLabel+'</a>'+
            '<button class="btn btn-outline" data-modal="modal-'+ev.id+'">Details</button>'+
          '</div>'+
        '</div>'+
      '</article>'
    );
  }

  function modalHTML(ev){
    const hasLink = !!ev.signin_link;
    const btnLabel = getBtnLabel(ev);
    const signinHref = hasLink ? ev.signin_link : '#';
    const img = ev.image_url || '/assets/img/about.png';

    return (
      '<div class="modal" id="modal-'+ev.id+'" role="dialog" aria-modal="true" aria-labelledby="modal-'+ev.id+'-title" hidden>'+
        '<div class="dialog" tabindex="-1">'+
          '<div class="modal-header" style="text-align:center;position:relative">'+
            '<h3 class="modal-title" id="modal-'+ev.id+'-title">'+(ev.title||'')+'</h3>'+
            '<button class="modal-close" type="button" data-close aria-label="Close">✕</button>'+
          '</div>'+
          '<section style="text-align:center">'+
            '<img class="convention-thumb" src="'+img+'" alt="'+(ev.title||'Event photo')+'" onerror="this.onerror=null;this.src=\'/assets/img/about.png\'">'+
            '<p class="kicker event-meta"><strong>'+ (ev.datePretty||'') +'</strong>'+ (ev.location? ' • '+ev.location : '') +'</p>'+
            (ev.details ? '<p>'+ev.details+'</p>' : '')+
            '<div style="display:flex;gap:.5rem;flex-wrap:wrap;justify-content:center;margin-top:1rem">'+
              '<a class="btn" data-action="signin" data-has-link="'+(hasLink?'1':'0')+'" href="'+signinHref+'" target="_blank" rel="noopener">'+btnLabel+'</a>'+
              '<a class="btn btn-outline" href="'+ gcalLink(ev) +'" target="_blank" rel="noopener">Add to Calendar</a>'+
            '</div>'+
          '</section>'+
        '</div>'+
      '</div>'
    );
  }

  /* ---------- Build from sheet ---------- */
  function buildEvents(recs){
    const now = new Date();
    return recs.map(r => {
      const date = parseDate(r.date || r.day || r.event_date);

      const stRaw = r.start_time || r.start || r.begin || '';
      const etRaw = r.end_time   || r.end   || r.finish || '';
      const rangeRaw = r.time || r.time_range || r.times || '';

      let st = parseTime(stRaw);
      let et = parseTime(etRaw);
      if((!st || !et) && rangeRaw){
        const rng = parseTimeRange(rangeRaw);
        if(rng){ st = st || rng.start; et = et || rng.end; }
      }

      const start = date ? combineDateTime(date, st || {h:0,m:0}) : new Date();
      let end = date ? (et ? combineDateTime(date, et) : new Date(start.getTime() + 60*60*1000))
                     : new Date(start.getTime() + 60*60*1000);

      if(end <= start){
        if(rangeRaw) end = new Date(end.getTime() + 24*60*60*1000);
        else end = new Date(start.getTime() + 60*60*1000);
      }

      const when = end < now ? 'past' : 'upcoming';
      const tags = normalizeTags(r.tags);
      const slugs = tags.map(tagSlug);

      return {
        id: Math.random().toString(36).slice(2),
        title: r.title || r.name || '',
        date: r.date,
        start_time: r.start_time,
        end_time: r.end_time,
        startDateTime: start,
        endDateTime: end,
        datePretty: formatDateRange(start, end),
        location: r.location || '',
        tags,
        tagSlugs: slugs,
        description: r.description || '',
        details: r.details || '',
        signin_link: r.signin_link || r.rsvp || '',
        image_url: r.image_url || r.image || '/assets/img/about.png',
        when
      };
    });
  }

  function openModal(m){ if(!m) return; m.hidden=false; m.classList.add('open'); document.body.style.overflow='hidden'; m.querySelector('.dialog')?.focus({preventScroll:true}); }
  function closeModal(m){ if(!m) return; m.classList.remove('open'); m.hidden=true; document.body.style.overflow=''; }

  function attachModalHandlers(){
    document.querySelectorAll('[data-modal]').forEach(btn=>{
      btn.addEventListener('click',()=> openModal(document.getElementById(btn.getAttribute('data-modal'))));
    });
    document.querySelectorAll('.modal').forEach(m=>{
      m.addEventListener('click',(e)=>{ if(e.target===m) closeModal(m); });
      m.querySelectorAll('[data-close]').forEach(b=> b.addEventListener('click',()=> closeModal(m)));
    });
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') document.querySelectorAll('.modal.open').forEach(closeModal); });
  }

  function showNotice(){ openModal(document.getElementById('notice-modal')); }
  document.addEventListener('click',(e)=>{
    const a = e.target.closest('a[data-action="signin"]');
    if(!a) return;
    const hasLink = a.getAttribute('data-has-link') === '1';
    const href = a.getAttribute('href');
    if(!hasLink || !href || href === '#'){ e.preventDefault(); showNotice(); }
  });

  function render(events){
    if(!events.length){
      listEl.innerHTML = '<p class="kicker">No upcoming events yet. Check back soon!</p>';
      return;
    }
    const cards = events.map(cardHTML).join('\n');
    const modals = events.map(modalHTML).join('\n');
    listEl.innerHTML = cards + '\n' + modals;
    attachModalHandlers();
  }

  async function init(){
    if(!listEl.innerHTML.trim()){ listEl.innerHTML = '<p class="kicker">Loading events…</p>'; }
    try{
      const csv = await fetchCSV(); // ← uses primary, falls back to Google Sheet
      const recs = toRecords(parseCSV(csv));
      const all = buildEvents(recs);

      // Only upcoming; earliest first; take top 3
      const upcoming = all
        .filter(ev => ev.when === 'upcoming')
        .sort((a,b)=> a.startDateTime - b.startDateTime)
        .slice(0,3);

      render(upcoming);
    } catch(err){
      console.error('Home events load failed:', err);
      listEl.innerHTML = `
        <div class="card"><div class="card-body">
          <p class="kicker">Couldn’t load events on this device.</p>
          <button class="btn" id="retry-home-events">Try again</button>
        </div></div>`;
      document.getElementById('retry-home-events')?.addEventListener('click', init, { once:true });
    }
  }

  window.addEventListener('DOMContentLoaded', init);
})();
</script>


<script src="/js/core.js" defer></script>
</body>
</html>
