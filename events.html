<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Events | Rowan ACDA</title>
<link href="images/logo.png" rel="icon" type="image/svg+xml"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet"/>
<link href="css/style.css" rel="stylesheet"/>
<script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<script defer src="js/app.js"></script>

<!-- PapaParse for CSV parsing -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
/* Popup modal like eboard, with overlay and scroll lock */
#modal-overlay{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  z-index:999;
}
.card-content{
  display:none;
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:#fff;
  padding:24px;
  border:1px solid #ddd;
  box-shadow:0 10px 30px rgba(0,0,0,.2);
  z-index:1000;
  max-width:680px;
  width:92%;
  max-height:85vh;
  overflow:auto;
  border-radius:14px;
}
body.modal-open{overflow:hidden;}
/* Grid + cards (works with your existing .card/.cards classes) */
.cards{
  display:grid;
  gap:16px;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
}
.card .aspect{
  aspect-ratio:16/9;
  overflow:hidden;
  border-radius:12px;
  background:#f3f4f6;
}
.card .aspect img{ width:100%; height:100%; object-fit:cover; display:block; }
.card h3{ margin:.5rem 0 .25rem; }
.card p.muted{ opacity:.8; margin:.25rem 0 .5rem; }
</style>
</head>

<body>
<div id="navbar"></div>

<main class="container">
    <section class="hero-banner" style="background-image:url('images/52848310914_2abe6f0220_o-scaled.jpg')">
      <div>
        <div class="banner-kicker">Rowan ACDA</div>
        <h1 class="banner-title">Events</h1>
        <p class="banner-sub">Workshops, meetings, performances, and service opportunities throughout the year.</p>
      </div>
    </section>

    <section class="section">
      <div class="callout">
        <div>
          <h3>Bring a friend</h3>
          <p>Most events welcome guests—share the sign‑in link to help us track attendance.</p>
        </div>
        <img src="images/516291973_10163646834723478_1263954820532907076_n.jpg" alt="Bring a friend">
      </div>
    </section>
    
    
  <section class="card">
    <h1>Events</h1>
    <p>View our Upcoming Events here! Click on any event card to learn more, access resources, and sign in or sign up!</p>

    <!-- Cards get injected here -->
    <div id="events-grid" class="cards" style="margin-top:16px"></div>
  </section>
</main>

<footer class="site-footer">
  © <span id="year"></span> Rowan ACDA. All rights reserved.
</footer>
<script>document.getElementById('year').textContent = new Date().getFullYear();</script>

<div id="modal-overlay"></div>

<script>
// ===== Modal controls (kept from your original) =====
function closeAll(){
  document.querySelectorAll('.card-content').forEach(c=>c.style.display='none');
  const ov = document.getElementById('modal-overlay');
  if (ov) ov.style.display = 'none';
  document.body.classList.remove('modal-open');
}
function showCard(id){
  closeAll();
  const card = document.getElementById(`card-${id}`);
  if(card){
    card.style.display='block';
    const ov = document.getElementById('modal-overlay');
    if (ov) ov.style.display = 'block';
    document.body.classList.add('modal-open');
  }
}
function hideCard(){ closeAll(); }
document.addEventListener('click', (e)=>{
  if (e.target && e.target.id === 'modal-overlay') hideCard();
});
document.addEventListener('keydown', (e)=>{
  if (e.key === 'Escape') hideCard();
});

// ===== Events: fetch from your Google Sheet CSV and render =====
const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSESaEnsqhseKRcrAkMj0Gu-gEAzHjYYdfTlpkAxaUVyUl6MERihQkWTMVlzk7nbWA3xE9g1orMChUo/pub?gid=0&single=true&output=csv";
const IMG_FALLBACK = "images/event-placeholder.png";

// Normalize CSV headers to snake_case
function normalizeRow(row) {
  const out = {};
  for (const k in row) {
    const key = String(k || "").trim().toLowerCase().replace(/\s+/g, "_");
    out[key] = row[k];
  }
  return out;
}

// Format "9/12/2025" as "Fri, Sep 12, 2025"
function formatDatePretty(mdy) {
  const d = new Date(mdy);
  if (isNaN(d)) return mdy;
  return d.toLocaleDateString(undefined, { weekday:'short', year:'numeric', month:'short', day:'numeric' });
}

// Sort by start datetime (uses first time in the range)
function startDateFrom(item){
  const dateStr = (item.date||"").trim();
  const startTime = (item.time||"").split("-")[0]?.trim() || "";
  const dt = new Date(`${dateStr} ${startTime}`);
  return isNaN(dt) ? new Date(dateStr) : dt;
}

async function fetchEventsFromSheet() {
  const res = await fetch(SHEET_CSV_URL, { cache: "no-store" });
  const csv = await res.text();
  return new Promise((resolve, reject) => {
    Papa.parse(csv, {
      header: true,
      skipEmptyLines: true,
      complete: ({ data }) => {
        const items = data
          .map(normalizeRow)
          .filter(r => r.event_title || r.title) // allow either header
          .map(r => ({
            title: (r.event_title || r.title || "").trim(),
            type: (r.type || "").trim(),
            date: (r.date || "").trim(),                 // e.g., "9/12/2025"
            time: (r.time || "").trim(),                 // e.g., "3:00pm - 4:00pm"
            short: (r.short_description || r.short || "").trim(),
            long: (r.long_description || r.long || "").trim(),
            image: (r.image || "").trim()
          }))
          .sort((a,b)=> startDateFrom(a) - startDateFrom(b));
        resolve(items);
      },
      error: reject
    });
  });
}

function renderEvents(events){
  const grid = document.getElementById("events-grid");
  grid.innerHTML = "";

  if (!events.length){
    grid.innerHTML = `<p>No events found.</p>`;
    return;
  }

  // Build cards and popups
  const frag = document.createDocumentFragment();
  const modalFrag = document.createDocumentFragment();

  events.forEach((e, idx) => {
    const id = idx + 1;
    const imgSrc = e.image || IMG_FALLBACK;

    // Card
    const card = document.createElement("div");
    card.className = "card";
    card.setAttribute("tabindex", "0"); // focusable
    card.addEventListener("click", ()=>showCard(id));
    card.addEventListener("keypress", (ev)=>{ if(ev.key==='Enter' || ev.key===' ') showCard(id); });

    card.innerHTML = `
      <div class="aspect">
        <img src="${imgSrc}" alt="${e.title.replace(/"/g,'&quot;')}">
      </div>
      <h3>${e.title}</h3>
      <p class="muted">${formatDatePretty(e.date)}${e.time ? "" : ""}</p>
      ${e.short ? `<p>${e.short}</p>` : ""}
    `;
    frag.appendChild(card);

    // Modal content
    const modal = document.createElement("div");
    modal.className = "card-content";
    modal.id = `card-${id}`;
    const typeLabel = e.type ? `Type: ${e.type} | ` : "";
    const timeLabel = e.time ? ` | Time: ${e.time}` : "";
    modal.innerHTML = `
      <h2>${e.title}</h2>
      <p>${typeLabel}Date: ${formatDatePretty(e.date)}${timeLabel}</p>
      ${e.long ? `<p>${e.long}</p>` : (e.short ? `<p>${e.short}</p>` : "")}
      <button onclick="hideCard()">Close</button>
    `;
    modalFrag.appendChild(modal);
  });

  grid.appendChild(frag);
  document.body.appendChild(modalFrag);
}

// Bootstrap
(async () => {
  try{
    const events = await fetchEventsFromSheet();
    renderEvents(events);
  } catch(err){
    console.error(err);
    document.getElementById("events-grid").innerHTML = `<p>There was a problem loading events.</p>`;
  }
})();
</script>

</body>
</html>
