name: Mirror events CSV hourly

on:
  schedule:
    - cron: "0 * * * *"   # every hour, on the hour (UTC)
  workflow_dispatch:       # manual run button

permissions:
  contents: write

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch latest CSV
        env:
          SRC_URL: https://docs.google.com/spreadsheets/d/e/2PACX-1vQgnEZCsF6om55MFRpD3Dy3xLNF0nSO7U228ijGXkZGSGPpZMqGitInVmgi6y8cYF56mEK8GOuGl0D7/pub?gid=0&single=true&output=csv
          DEST: assets/data/events.csv
        run: |
          mkdir -p "$(dirname "$DEST")"
          tmp=$(mktemp)
          curl -fsSL --retry 3 --retry-delay 5 --max-time 30 \
               -A "RowanACDA/1.0 (GitHub Action)" \
               "$SRC_URL" -o "$tmp"

          if [ ! -s "$tmp" ]; then
            echo "Download empty or failed"; exit 1
          fi

          if [ -f "$DEST" ] && cmp -s "$tmp" "$DEST"; then
            echo "No changes."; exit 0
          fi

          mv "$tmp" "$DEST"

      - name: Commit & push if changed
        run: |
          if git status --porcelain | grep -q "assets/data/events.csv"; then
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add assets/data/events.csv
            git commit -m "chore(data): mirror events.csv from Google Sheets [skip ci]"
            git push
          else
            echo "Nothing to commit."
          fi
