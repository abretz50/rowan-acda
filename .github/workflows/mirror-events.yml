name: Mirror events CSV hourly

on:
  schedule:
    - cron: "0 * * * *"   # every hour (UTC)
  workflow_dispatch:

concurrency:
  group: mirror-events
  cancel-in-progress: false

permissions:
  contents: write

env:
  BRANCH: main
  # >>> Replace with your real sheet ID (the long string after /d/ in the URL)
  SHEET_ID: 1AbCdefGhijKlmnOpQRstuVWxyz0123456789
  # >>> Replace if your sheet tab isn't the first; use the tab's gid from the URL
  GID: "0"
  DEST: assets/data/events.csv

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ env.BRANCH }}
          fetch-depth: 0

      - name: Fetch latest CSV (live export, cache-busted)
        run: |
          set -euo pipefail

          # Build live export URL (requires the sheet to be viewable by "Anyone with the link")
          URL="https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}&cachebust=${GITHUB_RUN_ID}"

          mkdir -p "$(dirname "$DEST")"
          tmp="$(mktemp)"

          # Show headers to confirm we didn't get HTML
          echo ">>> Requesting: $URL"
          curl -sI "$URL" | sed -n '1,20p'

          # Download
          curl -fsSL --retry 3 --retry-delay 5 --max-time 30 \
               -A "RowanACDA/1.0 (GitHub Action)" \
               "$URL" -o "$tmp"

          # Basic sanity checks
          if [ ! -s "$tmp" ]; then
            echo "::error::Download empty or failed."
            exit 1
          fi
          filetype="$(file -b --mime-type "$tmp")"
          if ! echo "$filetype" | grep -qiE 'text/csv|application/vnd\.ms-excel'; then
            echo "::error::Expected CSV, got $filetype. Is the sheet shared as 'Anyone with the link can view'?"
            head -n 20 "$tmp" || true
            exit 1
          fi

          # If unchanged, skip commit
          if [ -f "$DEST" ] && cmp -s "$tmp" "$DEST"; then
            echo "No changes."
            rm -f "$tmp"
            echo "NO_CHANGES=1" >> "$GITHUB_ENV"
            exit 0
          fi

          mv "$tmp" "$DEST"
          echo "NO_CHANGES=0" >> "$GITHUB_ENV"
          echo "Preview of new CSV:"
          head -n 5 "$DEST" || true

      - name: Commit change
        if: env.NO_CHANGES == '0'
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "$DEST"
          git commit -m "chore(data): mirror events.csv from Google Sheets (live export) [skip ci]"

      - name: Rebase on remote & push
        if: env.NO_CHANGES == '0'
        run: |
          set -e
          git pull --rebase --autostash origin "$BRANCH" || { git rebase --abort; exit 1; }
          git push origin HEAD:"$BRANCH"
